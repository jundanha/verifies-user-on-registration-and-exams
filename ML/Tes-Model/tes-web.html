<!DOCTYPE html>
<html>
<head>
    <title>Siamese Network Example</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
</head>
<body>
    <input type="file" id="fileInput1">
    <img id="imageElement1" style="display:flex;max-width:500px">

    <input type="file" id="fileInput2">
    <img id="imageElement2" style="display:flex;max-width:500px">

    <button id="predictButton">Predict</button>
    <div id="output"></div>
    <!-- <script src="custom-layer.js" type="module"></script> contain substract layer -->
    <script type="module">
        //import {subtract} from './custom-layer.js'
        async function runModel() {
            // Check if TensorFlow.js is loaded
            if (typeof tf === 'undefined') {
                console.log('TensorFlow.js not loaded');
                return;
            } else {
                console.log('TensorFlow.js loaded');
            }

            // Load the model
            const model = await tf.loadLayersModel('./model/model.json') //{customObject : {'Subtract': subtract()}});

            // Check if the model is loaded successfully
            if (!model) {
                console.log('Model loading failed');
                return;
            } else {
                console.log('Model loaded');
            }

            document.getElementById('predictButton').onclick = async function () {
                try {
                    const file1 = document.getElementById('fileInput1').files[0];
                    const file2 = document.getElementById('fileInput2').files[0];
                    
                    const img1 = document.getElementById('imageElement1');
                    const img2 = document.getElementById('imageElement2');

                    img1.src = URL.createObjectURL(file1);
                    img2.src = URL.createObjectURL(file2);

                    // Ensure both images are loaded before further processing
                    await Promise.all([loadImage(img1), loadImage(img2)]);

                    const tensor1 = preprocessImage(img1);
                    const tensor2 = preprocessImage(img2);

                    const predictions = model.predict([tensor1, tensor2]);
                    const values = await predictions.data();
                    displayPredictions(values);
                } catch (error) {
                    console.error('Error occurred during prediction:', error);
                }
            };
        }

        async function loadImage(imgElement) {
            return new Promise(resolve => {
                imgElement.onload = resolve;
            });
        }

        function preprocessImage(imgElement) {
            return tf.tidy(() => {
                const tensor = tf.browser.fromPixels(imgElement)
                    .resizeNearestNeighbor([128, 128])
                    .expandDims()
                    .toFloat().div(255);
                return tensor;
            });
        }

        function displayPredictions(values) {
            const output = document.getElementById('output');
            output.innerHTML = '';
            
            const predictionLabel = values[0] > 0.5 ? 'Similar' : 'Different';
            
            const node = document.createElement('div');
            node.innerText = `Prediction value: ${values[0]} --> Images are ${predictionLabel}`;
            output.appendChild(node);
        }

        document.addEventListener('DOMContentLoaded', runModel);
    </script>
</body>
</html>
